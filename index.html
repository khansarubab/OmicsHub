<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>OmicsHub</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    #voiceCameraWrapper { display: flex; gap: 10px; }
    #voiceCameraWrapper button { flex: 1; }
</style>
</head>
<body>
<div class="top-bar d-flex justify-content-between align-items-center px-4 py-3 bg-light shadow-sm">
    <h3 class="app-title">ðŸ§¬ OmicsHub</h3>
    <select id="languageSelect" class="form-select w-auto">
        <option value="en">English</option>
        <option value="ur">Ø§Ø±Ø¯Ùˆ</option>
        <option value="ru">Roman Urdu</option>
    </select>
</div>

<div class="container mt-5">
    <div class="card main-card shadow p-4">
        <h4 class="text-center mb-4" id="appSubtitle">Integrated Multi-Omics Explorer</h4>

        <div class="mb-3">
            <label class="form-label">Upload Omics File (CSV / JSON)</label>
            <input type="file" id="omicsFile" class="form-control">
        </div>

        <div class="mb-3">
            <label class="form-label">Upload Genomics / Proteomics File</label>
            <input type="file" id="genomicsFile" class="form-control">
        </div>

        <div class="mb-3" id="voiceCameraWrapper">
            <button class="btn btn-secondary" id="voiceBtn">ðŸŽ¤ Voice Input</button>
            <button class="btn btn-secondary" id="cameraBtn">ðŸ“· Camera</button>
            <input type="file" id="imageUpload" accept="image/*" hidden>
        </div>

        <div class="mb-3">
            <label class="form-label">Enter Gene / Protein Name(s)</label>
            <input type="text" id="geneInput" class="form-control" placeholder="TP53, BRCA1">
        </div>

        <div class="d-grid mb-4">
            <button class="btn btn-primary btn-lg" id="analyzeBtn">Analyze Omics Data</button>
        </div>

        <h5>Analysis Results:</h5>
        <table class="table table-bordered">
            <thead>
                <tr><th>Gene</th><th>Status</th></tr>
            </thead>
            <tbody id="resultsBody"></tbody>
        </table>

        <canvas id="resultsChart"></canvas>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const languageSelect = document.getElementById("languageSelect");
    const subtitle = document.getElementById("appSubtitle");
    const voiceBtn = document.getElementById("voiceBtn");
    const analyzeBtn = document.getElementById("analyzeBtn");
    const geneInput = document.getElementById("geneInput");
    const resultsBody = document.getElementById("resultsBody");
    const resultsChartCanvas = document.getElementById("resultsChart");
    const omicsFileInput = document.getElementById("omicsFile");
    const genomicsFileInput = document.getElementById("genomicsFile");
    const imageUpload = document.getElementById("imageUpload");
    let chart = null;

    // Translation support
    const translations = {
        en: { subtitle: "Integrated Multi-Omics Explorer", voice: "ðŸŽ¤ Voice Input", analyze: "Analyze Omics Data" },
        ur: { subtitle: "Ù…Ù„Ù¹ÛŒ Ø§ÙˆÙˆÙ…Ú©Ø³ ÚˆÛŒÙ¹Ø§ Ø§ÛŒÚ©Ø³Ù¾Ù„ÙˆØ±Ø±", voice: "ðŸŽ¤ ÙˆØ§Ø¦Ø³ Ø§Ù† Ù¾Ù¹", analyze: "ØªØ¬Ø²ÛŒÛ Ú©Ø±ÛŒÚº" },
        ru: { subtitle: "Integrated Multi-Omics Explorer", voice: "ðŸŽ¤ Voice Input", analyze: "Analyze" }
    };

    languageSelect.addEventListener("change", () => {
        const lang = languageSelect.value;
        subtitle.innerText = translations[lang].subtitle;
        voiceBtn.innerText = translations[lang].voice;
        analyzeBtn.innerText = translations[lang].analyze;
    });

    // Voice input
    if ("SpeechRecognition" in window || "webkitSpeechRecognition" in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;

        voiceBtn.addEventListener("click", async () => {
            recognition.lang = languageSelect.value === "ur" ? "ur-PK" :
                               languageSelect.value === "ru" ? "en-PK" : "en-US";
            try {
                await navigator.mediaDevices.getUserMedia({ audio: true });
                recognition.start();
                voiceBtn.innerText = "ðŸŽ™ Listening...";
            } catch { alert("Microphone permission required"); }
        });

        recognition.onresult = (e) => { 
            geneInput.value = e.results[0][0].transcript; 
            voiceBtn.innerText = translations[languageSelect.value].voice; 
        };
        recognition.onend = () => { voiceBtn.innerText = translations[languageSelect.value].voice; };
    } else { voiceBtn.disabled = true; voiceBtn.innerText = "ðŸŽ¤ Not Supported"; }

    // Analyze button + backend fetch
    analyzeBtn.addEventListener("click", async () => {
        const genes = geneInput.value.split(",").map(g => g.trim()).filter(Boolean);
        if (genes.length === 0) { alert("Please enter gene names"); return; }

        resultsBody.innerHTML = "";

        // CSV file content
        let csvData = "";
        if (omicsFileInput.files[0]) {
            csvData = await omicsFileInput.files[0].text();
        }

        // FormData for backend
        const formData = new FormData();
        formData.append("gene", geneInput.value);
        formData.append("csvData", csvData);
        if (genomicsFileInput.files[0]) formData.append("genomicsFile", genomicsFileInput.files[0]);
        if (imageUpload.files[0]) formData.append("imageFile", imageUpload.files[0]);

        try {
            // ðŸ”¹ Use Render backend public URL here
            const backendURL = "https://omicshub-backend.onrender.com/analyze";
            const response = await fetch(backendURL, { method: "POST", body: formData });
            const data = await response.json();

            data.found_genes.forEach(item => {
                const row = resultsBody.insertRow();
                row.insertCell(0).innerText = item.gene;
                row.insertCell(1).innerText = item.status; // "âœ… Found" or "âŒ Not Found"
            });

            if (chart) chart.destroy();
            chart = new Chart(resultsChartCanvas, {
                type: "bar",
                data: {
                    labels: data.found_genes.map(d => d.gene),
                    datasets: [{ label: "Gene Status", data: data.found_genes.map(d => d.status === "âœ… Found" ? 1 : 0) }]
                },
                options: { scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
            });

            alert(data.message);

        } catch(err) { alert("Failed to fetch backend: " + err.message); }
    });
});
</script>
</body>
</html>
