<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>OmicsHub</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
    #voiceCameraWrapper { display: flex; gap: 10px; }
    #voiceCameraWrapper button { flex: 1; }
</style>
</head>
<body>
<div class="top-bar d-flex justify-content-between align-items-center px-4 py-3 bg-light shadow-sm">
    <h3 class="app-title">ðŸ§¬ OmicsHub</h3>
</div>

<div class="container mt-5">
    <div class="card main-card shadow p-4">
        <h4 class="text-center mb-4">Integrated Multi-Omics Explorer</h4>

        <div class="mb-3">
            <label class="form-label">Upload Omics File (CSV)</label>
            <input type="file" id="omicsFile" class="form-control">
        </div>

        <div class="mb-3">
            <label class="form-label">Enter Gene / Protein Name(s)</label>
            <input type="text" id="geneInput" class="form-control" placeholder="TP53, BRCA1">
        </div>

        <div class="d-grid mb-4">
            <button class="btn btn-primary btn-lg" id="analyzeBtn">Analyze Omics Data</button>
        </div>

        <h5>Gene Results:</h5>
        <table class="table table-bordered">
            <thead>
                <tr><th>Gene</th><th>Status</th></tr>
            </thead>
            <tbody id="resultsBody"></tbody>
        </table>

        <h5>Pathway Enrichment:</h5>
        <table class="table table-bordered">
            <thead>
                <tr><th>Pathway</th><th>p-value</th></tr>
            </thead>
            <tbody id="pathwayBody"></tbody>
        </table>

        <canvas id="resultsChart"></canvas>
        <button class="btn btn-danger mt-3" id="downloadPdfBtn">ðŸ“„ Download PDF Report</button>
    </div>
</div>

<script>
let chart = null;
let lastResultData = null;

document.getElementById("analyzeBtn").addEventListener("click", async () => {
    const geneInput = document.getElementById("geneInput").value.trim();
    if (!geneInput) { alert("Please enter gene names"); return; }

    let csvData = "";
    if (document.getElementById("omicsFile").files[0]) {
        csvData = await document.getElementById("omicsFile").files[0].text();
    }

    const genes = geneInput.split(",").map(g => g.trim()).filter(Boolean);
    const found_genes = genes.map(g => ({
        gene: g,
        status: csvData.toLowerCase().includes(g.toLowerCase()) ? "âœ… Found" : "âŒ Not Found"
    }));

    // Example pathway enrichment (replace with real backend API later)
    const pathway_enrichment = [
        { pathway: "Cell Cycle Regulation", pval: "1.20e-4" },
        { pathway: "DNA Repair Pathway", pval: "4.50e-3" },
        { pathway: "Cancer Signaling", pval: "1.80e-3" }
    ];

    lastResultData = { found_genes, pathway_enrichment };

    // Update Gene table
    const resultsBody = document.getElementById("resultsBody");
    resultsBody.innerHTML = "";
    found_genes.forEach(item => {
        const row = resultsBody.insertRow();
        row.insertCell(0).innerText = item.gene;
        row.insertCell(1).innerText = item.status;
    });

    // Update Pathway table
    const pathwayBody = document.getElementById("pathwayBody");
    pathwayBody.innerHTML = "";
    pathway_enrichment.forEach(item => {
        const row = pathwayBody.insertRow();
        row.insertCell(0).innerText = item.pathway;
        row.insertCell(1).innerText = item.pval;
    });

    // Chart
    if (chart) chart.destroy();
    const ctx = document.getElementById("resultsChart").getContext("2d");
    chart = new Chart(ctx, {
        type: "bar",
        data: {
            labels: found_genes.map(d => d.gene),
            datasets: [{ 
                label: "Gene Status", 
                data: found_genes.map(d => d.status === "âœ… Found" ? 1 : 0),
                backgroundColor: found_genes.map(d => d.status === "âœ… Found" ? "#4caf50" : "#f44336")
            }]
        },
        options: { scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
    });
});

// PDF Download
document.getElementById("downloadPdfBtn").addEventListener("click", () => {
    if (!lastResultData) { alert("No results to download"); return; }

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();

    pdf.setFontSize(18);
    pdf.text("OmicsHub - Analysis Report", 14, 20);
    pdf.setFontSize(12);
    pdf.text(`Date: ${new Date().toLocaleString()}`, 14, 30);

    let y = 45;
    pdf.text("Gene Analysis Results:", 14, y);
    y += 10;
    lastResultData.found_genes.forEach(item => {
        pdf.text(`${item.gene} : ${item.status}`, 16, y);
        y += 8;
    });

    y += 10;
    pdf.text("Pathway Enrichment:", 14, y);
    y += 10;
    lastResultData.pathway_enrichment.forEach(item => {
        pdf.text(`${item.pathway} : ${item.pval}`, 16, y);
        y += 8;
    });

    // Add chart as image
    const chartImage = document.getElementById("resultsChart").toDataURL("image/png");
    pdf.addPage();
    pdf.text("Visualization", 14, 20);
    pdf.addImage(chartImage, "PNG", 15, 30, 180, 100);

    pdf.save("OmicsHub_Report.pdf");
});
</script>
</body>
</html>
